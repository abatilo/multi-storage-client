version: '3.8'

services:
  # Prometheus instance set up to scrape the various metrics endpoings of msfs
  prometheus:
    image: prom/prometheus:v3.8.1
    container_name: msfs_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

  # Grafana instance to graphically present the metrics scraped by Prometheus
  grafana:
    image: grafana/grafana:12.1
    container_name: msfs_grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    volumes:
      - ./grafana.ini:/etc/grafana/grafana.ini
      - ./grafana-provisioning:/etc/grafana/provisioning

  # Observability: OTLP Collector (receives metrics from MSFS)
  # Note: This just logs the metrics to console. For production, configure exporters  
  # to send to your observability backend (Prometheus, Grafana Cloud, Datadog, etc.)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.138.0
    container_name: msfs_otel_collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Collector's own metrics

  # Storage Backends
  garage:
    build:
      context: ..
      dockerfile: multi-storage-file-system/Dockerfile
      target: garage
    container_name: msfs_garage
    ports:
      - "3900:3900"
      - "3903:3903"
    environment:
      - GARAGE_ADMIN_TOKEN=test_admin_token
      - GARAGE_ALLOW_HTTP=true
    command: /root/garage.sh
  minio:
    build:
      context: ..
      dockerfile: multi-storage-file-system/Dockerfile
      target: minio
    container_name: msfs_minio
    expose:
      - 9000
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: /minio/minio server /data
  fake-gcs:
    build:
      context: ..
      dockerfile: multi-storage-file-system/Dockerfile
      target: fake-gcs
    container_name: msfs_fake-gcs
    expose:
      - 4443
    command: ["-scheme", "http", "-data", "/data"]
  ais:
    build:
      context: ..
      dockerfile: multi-storage-file-system/Dockerfile
      target: ais
    container_name: msfs_ais
    expose:
      - 8080
      - 8081
    depends_on:
      - minio
    environment:
      - S3_ENDPOINT=http://minio:9000
    command: [ "/root/deploy_1_1.sh" ]
  # Test clean Ubuntu Linux Container
  #
  # Note:
  #   apt update && apt -y upgrade && apt install -y fuse3
  #   cd /multi-storage-client/multi-storage-file-system/
  ubuntu:
    image: ubuntu:24.04
    container_name: msfs_ubuntu
    cap_add:
      - SYS_ADMIN
    devices:
      - '/dev/fuse'
    privileged: true
    volumes:
      - type: bind
        source: ..
        target: /multi-storage-client
    command: ["sleep", "infinity"]
  # Test clean Rocky Linux Container
  #
  # Note:
  #   dnf install -y fuse procps-ng
  #   cd /multi-storage-client/multi-storage-file-system/
  rocky:
    image: rockylinux:9.3
    container_name: msfs_rocky
    cap_add:
      - SYS_ADMIN
    devices:
      - '/dev/fuse'
    privileged: true
    volumes:
      - type: bind
        source: ..
        target: /multi-storage-client
    command: ["sleep", "infinity"]
  # Development Container
  dev:
    build:
      context: ..
      dockerfile: multi-storage-file-system/Dockerfile
      target: dev
    container_name: msfs_dev
    expose:
      - 9088
    ports:
      - "9088:9088"
    depends_on:
      - prometheus
      - grafana
      - otel-collector
      - garage
      - minio
      - fake-gcs
      - ais
      - ubuntu
      - rocky
    cap_add:
      - SYS_ADMIN
    devices:
      - '/dev/fuse'
    privileged: true
    volumes:
      - type: bind
        source: ..
        target: /multi-storage-client
    environment:
      - AIS_ENDPOINT=http://ais:8080
      - MSC_CONFIG=./msfs_config_dev.yaml
      # Observability: OTLP endpoints (accessible from inside container)
      - OTEL_EXPORTER_OTLP_ENDPOINT=otel-collector:4317
    command: ["/usr/bin/tini", "--", "sleep", "infinity"]
